# コンテキスト管理ベストプラクティス

> **Version**: 1.0.0
> **Last Updated**: 2026-01-29
> **対象**: 足軽（Ashigaru）

## 概要

大規模タスクにおけるコンテキスト肥大化を防ぎ、安定してタスクを完遂するためのガイドライン。

## コンテキストエラーの根本原因

```
大規模タスク（1つのコンテキストで処理）
    ↓
Context肥大化（200K tokens超過）
    ↓
/compact失敗（Conversation too long）
    ↓
足軽停止・作業中断
```

## 解決策：Task toolによるサブエージェント活用

```
大規模タスク
    ↓
Task toolでサブエージェント起動（独立コンテキスト）
    ↓
各サブエージェントが分担処理
    ↓
結果のみをメインコンテキストに集約
    ↓
Context軽量化・安定稼働
```

## 判断基準：いつTask toolを使うか？

| 基準 | 閾値 | 対応 |
|------|------|------|
| Web検索回数 | 5回以上見込み | Task toolで分散 |
| ファイル読み取り | 10個以上見込み | Task toolで分散 |
| コード分析 | 500行以上 | Task toolで分散 |
| ドキュメント作成 | 5セクション以上 | Task toolで分散 |
| 並列処理 | サブタスク3つ以上 | Task toolで並列起動 |

## コンテキスト監視と対処

### Context残量チェック

作業中、常に以下の残量を監視せよ：

| 残量 | 状態 | 対応 |
|------|------|------|
| 50%以上 | 🟢 安全 | 継続 |
| 20-50% | 🟡 注意 | /compact検討 |
| 20%以下 | 🔴 危険 | **即/compact実行** |

### /compact実行のタイミング

以下の状況になったら、**即座に/compact**を実行せよ：

- Context残量が20%以下を表示された
- Web検索を5回以上実行した
- ファイルを10個以上読み込んだ
- 大規模なコード生成・分析を行った

### /compact失敗時のリカバリ手順

```
1. Escを2回押す（古いメッセージを削除）
2. /compactを再実行
3. それでも失敗したら/clearでリセット（最終手段）
```

## Task tool活用ガイド

### 基本的な使い方

```javascript
Task(
  subagent_type: "general-purpose",
  description: "具体的な作業内容",
  prompt: "詳細な指示書"
)
```

### 指示書の書き方テンプレート

```markdown
## タスクの目的
（何を達成するのか）

## 調査・分析範囲
（どの範囲を対象とするのか）

## 出力形式
（どのような形式で出力するのか）

## 参考リソース
（参考すべきURLやファイル）
```

### 具体例

**【例1：Webリサーチ】**

```
Task(
  subagent_type: "general-purpose",
  description: "GASのGmail連携方法をリサーチ",
  prompt: |
    Google Apps ScriptでのGmail操作方法を調査せよ。
    公式ドキュメントを参照し、以下を含むmarkdownを作成せよ：
    - GmailAppの主要メソッド
    - メール取得・送信のコード例
    - ベストプラクティス
)
```

**【例2：ファイル分析】**

```
Task(
  subagent_type: "general-purpose",
  description: "複数ファイルの分析",
  prompt: |
    以下のファイルを分析し、共通パターンを抽出せよ：
    - /path/to/file1.js
    - /path/to/file2.js
    - /path/to/file3.js
    
    出力はmarkdown形式で、パターン一覧と改善案を含めよ。
)
```

**【例3：ドキュメント作成】**

```
Task(
  subagent_type: "general-purpose",
  description: "技術ドキュメントの作成",
  prompt: |
    # タスク
    API仕様書を作成せよ
    
    # セクション構成
    1. 概要
    2. エンドポイント一覧
    3. 認証方法
    4. エラーコード
    5. サンプルコード
    
    # 出力先
    /path/to/api-spec.md
)
```

## 結果集約の手順

1. **サブエージェントの出力を確認**
   - 期待通りの品質か確認
   - 必要に応じて修正指示

2. **情報の抽出・整理**
   - 必要な情報のみを抽出
   - 自分のコンテキストに取り込む

3. **詳細情報の分離**
   - 中間データ・ログはサブエージェントのコンテキストに任せる
   - 結果と結論のみをメインコンテキストに保持

## サブエージェント活用パターン

| パターン | 説明 | 効果 |
|----------|------|------|
| **分散リサーチ** | 各トピックを別エージェントに割り当て | コンテキスト分割 |
| **並列分析** | 独立ファイルを同時処理 | 時間短縮＋軽量化 |
| **段階的生成** | ドキュメントをセクション単位で生成 | 1エージェントの負荷分散 |
| **フィードバックループ** | サブエージェントの結果を別エージェントでレビュー | 品質向上 |

## エラー復旧手順

### Conversation too long エラー

```
エラー発生
    ↓
Esc × 2（メッセージ削除）
    ↓
/compact再実行
    ↓
成功 → 作業継続
失敗 → /clear（最終手段）
```

### /clear 実施時の注意

- **作業中の情報が失われる**可能性
- 事前に報告書を作成してから実施
- どうしても復旧できない場合のみ使用

## 報告書への記載

サブエージェントを使用した場合は、報告書に以下を記載せよ：

```yaml
result:
  summary: "任務完了"
  sub_agents_used: 2
  approach: "Task toolによる分散処理"
  files_modified:
    - "/path/to/output.md"
  notes: |
    サブエージェント2を使用して並列処理を実施。
    コンテキスト肥大化を防ぎ、安定して完遂。
```

## まとめ

1. **Context残量を常に監視**（20%以下で即/compact）
2. **大規模タスクはTask toolで分散**（5回以上の検索で起動）
3. **結果のみを集約**（中間データはサブエージェントに任せる）
4. **エラー時は冷静に対処**（Esc → /compact → /clear）

これらを実践することで、大規模タスクでも安定して完遂できるであろう。
